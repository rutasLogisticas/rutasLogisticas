<div class="page-content">
  <h2>Mapas y Geolocalizaci√≥n</h2>

  <div *ngIf="error" class="error-text">{{ error }}</div>

  <div class="panel mapa-grid">
    <!-- PANEL DE B√öSQUEDA Y CONTROLES -->
    <div class="search-section">
      <h3>B√∫squeda de Ubicaciones</h3>
      
      <!-- Formulario de b√∫squeda -->
      <form (ngSubmit)="geocode()" class="search-form">
        <label>
          Direcci√≥n
          <input 
            name="address" 
            [(ngModel)]="address" 
            placeholder="Ej: Calle 72 #10-51, Bogot√°, Colombia"
            required 
          />
        </label>
        <div class="form-actions">
          <button type="submit" [disabled]="loading" class="btn-primary">
            {{ loading ? 'Buscando...' : 'Buscar' }}
          </button>
          <button type="button" (click)="getCurrentLocation()" class="btn-secondary" [disabled]="locationLoading">
            {{ locationLoading ? 'Obteniendo...' : 'Mi ubicaci√≥n' }}
          </button>
          <button type="button" (click)="clear()" class="btn-clear">Limpiar</button>
        </div>
      </form>

      <!-- Controles del mapa -->
      <div class="map-controls">
        <h4>Controles del Mapa</h4>
        <div class="control-buttons">
          <button (click)="zoomIn()" class="control-btn" [disabled]="currentZoom >= maxZoom">
            <span class="control-icon">+</span>
            <span class="control-label">Acercar</span>
          </button>
          <button (click)="zoomOut()" class="control-btn" [disabled]="currentZoom <= minZoom">
            <span class="control-icon">-</span>
            <span class="control-label">Alejar</span>
          </button>
          <button (click)="centerMap()" class="control-btn">
            <span class="control-icon">‚åÇ</span>
            <span class="control-label">Centrar</span>
          </button>
          <button (click)="toggleFullscreen()" class="control-btn">
            <span class="control-icon">‚õ∂</span>
            <span class="control-label">Pantalla completa</span>
          </button>
        </div>
      </div>

      <!-- Informaci√≥n de la ubicaci√≥n actual -->
      <div *ngIf="result" class="location-info">
        <h4>Ubicaci√≥n Encontrada</h4>
        <div class="info-item">
          <strong>Direcci√≥n:</strong> 
          <span class="address-text">{{ result.address }}</span>
        </div>
        <div class="info-item">
          <strong>Coordenadas:</strong>
          <span class="coordinates">{{ result.latitude.toFixed(6) }}, {{ result.longitude.toFixed(6) }}</span>
        </div>
        <div class="info-item">
          <strong>Zoom actual:</strong>
          <span class="zoom-level">{{ currentZoom }}</span>
        </div>
      </div>

      <!-- Historial de b√∫squedas -->
      <div *ngIf="searchHistory.length > 0" class="search-history">
        <h4>B√∫squedas Recientes</h4>
        <div class="history-list">
          <div 
            *ngFor="let item of searchHistory; trackBy: trackByHistory" 
            class="history-item"
            (click)="selectFromHistory(item)"
          >
            <span class="history-address">{{ item.address }}</span>
            <span class="history-coords">{{ item.latitude.toFixed(4) }}, {{ item.longitude.toFixed(4) }}</span>
          </div>
        </div>
        <button (click)="clearHistory()" class="btn-clear btn-small">Limpiar historial</button>
      </div>

      <!-- Secci√≥n de Rutas de Pedidos -->
      <div class="orders-section">
        <h3>Rutas de Pedidos</h3>
        
        <!-- Selector de modo de transporte -->
        <div class="route-mode-selector" *ngIf="showRouteMode">
          <label>
            Modo de transporte:
            <select [(ngModel)]="routeMode" (change)="changeRouteMode()">
              <option value="driving">En veh√≠culo</option>
              <option value="walking">Caminando</option>
              <option value="bicycling">En bicicleta</option>
              <option value="transit">Transporte p√∫blico</option>
            </select>
          </label>
        </div>

        <!-- Lista de pedidos -->
        <div class="orders-list" *ngIf="orders.length > 0">
          <div 
            *ngFor="let order of orders" 
            class="order-item"
            [class.selected]="selectedOrderId === order.id"
            (click)="selectOrder(order.id)"
          >
            <div class="order-header">
              <span class="order-number">{{ order.order_number }}</span>
              <span class="order-status" [style.background-color]="getStatusColor(order.status)">
                {{ order.status }}
              </span>
            </div>
            <div class="order-route">
              <span class="origin">{{ order.origin_city }}</span>
              <span class="arrow">‚Üí</span>
              <span class="destination">{{ order.destination_city }}</span>
            </div>
            <div class="order-priority">
              Prioridad: <strong>{{ order.priority }}</strong>
            </div>
          </div>
        </div>

          <!-- Informaci√≥n de la ruta seleccionada -->
        <div *ngIf="orderRoute" class="route-info">
          <h4>Informaci√≥n de la Ruta</h4>
          
          <!-- Indicadores visuales de origen y destino -->
          <div class="route-points">
            <div class="route-point origin-point">
              <div class="point-marker origin-marker">üìç</div>
              <div class="point-info">
                <strong>ORIGEN</strong>
                <div class="point-address">{{ orderRoute.route.origin }}</div>
              </div>
            </div>
            <div class="route-point destination-point">
              <div class="point-marker destination-marker">üèÅ</div>
              <div class="point-info">
                <strong>DESTINO</strong>
                <div class="point-address">{{ orderRoute.route.destination }}</div>
              </div>
            </div>
          </div>
          
          <div class="route-details">
            <div class="detail-item">
              <strong>Distancia:</strong> {{ orderRoute.route_distance }}
            </div>
            <div class="detail-item">
              <strong>Duraci√≥n:</strong> {{ orderRoute.route_duration }}
            </div>
            <div class="detail-item" *ngIf="orderRoute.estimated_delivery_time">
              <strong>Tiempo estimado de entrega:</strong> 
              {{ orderRoute.estimated_delivery_time | date:'short' }}
            </div>
          </div>
          
          <!-- Pasos de la ruta -->
          <div class="route-steps" *ngIf="orderRoute.route.steps.length > 0">
            <h5>Pasos de la Ruta</h5>
            <div class="steps-list">
              <div *ngFor="let step of orderRoute.route.steps; let i = index" class="step-item">
                <span class="step-number">{{ i + 1 }}</span>
                <div class="step-content">
                  <div class="step-instruction" [innerHTML]="step.instruction"></div>
                  <div class="step-details">
                    <span class="step-distance">{{ step.distance_text }}</span>
                    <span class="step-duration">{{ step.duration_text }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Controles de rutas -->
        <div class="route-controls">
          <button (click)="toggleRouteMode()" class="btn-primary">
            {{ showRouteMode ? 'Ocultar' : 'Mostrar' }} Modo de Transporte
          </button>
          <button (click)="toggleMapProvider()" class="btn-secondary">
            Cambiar a {{ useGoogleMaps ? 'OpenStreetMap' : 'Google Maps' }}
          </button>
          <button (click)="clearRoute()" class="btn-clear" [disabled]="!selectedOrderId">
            Limpiar Ruta
          </button>
        </div>
      </div>
    </div>

    <!-- CONTENEDOR DEL MAPA -->
    <div class="map-section">
      <div class="map-container" [class.fullscreen]="isFullscreen">
        <div class="map-wrapper">
          <iframe
            [src]="mapUrl | sanitizeUrl"
            frameborder="0"
            scrolling="no"
            class="map-frame"
          ></iframe>
          <div class="map-overlay" *ngIf="!result && !orderRoute">
            <div class="overlay-content">
              <div class="overlay-icon">üó∫Ô∏è</div>
              <p>Ingresa una direcci√≥n para ver la ubicaci√≥n en el mapa</p>
              <p class="overlay-subtitle">O selecciona un pedido para ver su ruta</p>
            </div>
          </div>
          
          <!-- Indicador de carga de ruta -->
          <div class="route-loading-overlay" *ngIf="routeLoading">
            <div class="loading-content">
              <div class="loading-spinner">‚è≥</div>
              <p>Calculando ruta...</p>
            </div>
          </div>
        </div>
        
        <!-- Informaci√≥n del mapa -->
        <div class="map-info" *ngIf="result || orderRoute">
          <div class="map-stats">
            <span class="stat-item" *ngIf="result">
              <strong>Latitud:</strong> {{ result.latitude.toFixed(6) }}
            </span>
            <span class="stat-item" *ngIf="result">
              <strong>Longitud:</strong> {{ result.longitude.toFixed(6) }}
            </span>
            <span class="stat-item" *ngIf="orderRoute">
              <strong>Ruta:</strong> {{ orderRoute.route.origin }} ‚Üí {{ orderRoute.route.destination }}
            </span>
            <span class="stat-item">
              <strong>Proveedor:</strong> {{ getMapProviderName() }}
            </span>
            <span class="stat-item">
              <strong>Zoom:</strong> {{ currentZoom }}
            </span>
          </div>
        </div>
      </div>

      <!-- Funciones adicionales -->
      <div class="additional-features">
        <h4>Funciones Adicionales</h4>
        <div class="feature-buttons">
          <button (click)="exportLocation()" class="feature-btn" [disabled]="!result">
            üìã Copiar coordenadas
          </button>
          <button (click)="shareLocation()" class="feature-btn" [disabled]="!result">
            üîó Compartir ubicaci√≥n
          </button>
          <button (click)="calculateDistance()" class="feature-btn" [disabled]="!result">
            üìè Calcular distancia
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
